<div id="article-form">
  <input type="button" value="Toggle Preview" onclick="togglePreview()">
  <%= form_with model: article, id: "content-form" do |form| %>
    <%= form.label :title %><br>
    <%= form.text_field :title, id: "article-title-input" %><br>
    <% article.errors.full_messages_for(:title).each do |message| %>
      <div><%= message %></div>
    <% end %>
    <%= form.label :body %><br>
    <%= form.text_area :body, class: "article-body", id: "article-body-input" %>
    <% article.errors.full_messages_for(:body).each do |message| %>
      <div><%= message %></div>
    <% end %>
    <%= form.label :visibility %>
    <%= form.check_box :visibility, class: "article-check-box", id: "article-check-box" %><br>
    <% article.errors.full_messages_for(:visibility).each do |message| %>
      <div><%= message %></div>
    <% end %><br>
    <%= form.submit %>
  <% end %>
  <div id="content">
    <h3>Preview</h3>
    <h2 id="article-title"></h2>
    <p id="article-body"></p>
  </div>
  <script>
    function togglePreview(){
      let form = document.getElementById("content-form")
      let preview = document.getElementById("content")
      if (!form.style.display && !preview.style.display) {
        form.style.display = "block"
        preview.style.display= "none"
      }
      form.style.display = preview.style.display
      preview.style.display = form.style.display == "block" ? "none" : "block"
    }

    function updatePreview(){
      let bodyInput = document.getElementById("article-body-input")
      let titleInput = document.getElementById("article-title-input")
      let bodyPreview = document.getElementById("article-body")
      let titlePreview = document.getElementById("article-title")

      bodyPreview.innerHTML = getContentFromString(bodyInput.value)
      titlePreview.innerHTML = titleInput.value.split("/").at(-1)
    }

    window.latestSetTimeoutFromForm = window.setTimeout(() => {
      let bodyInput = document.getElementById("article-body-input")
      let titleInput = document.getElementById("article-title-input")

      bodyInput.addEventListener('input', updatePreview)
      titleInput.addEventListener('input', updatePreview)
      updatePreview()
    }, 500)

    beforeVisitHandler = (e)=>{
      if (e.explicitOriginalTarget.tagName.toLowerCase() === "a" && !window.confirm("This page may have unsaved changes :3. Continue?")) {
        e.preventDefault()
      } else {
        window.removeEventListener('turbo:before-visit', window.beforeVisitHandler)
        window.clearTimeout(latestSetTimeoutFromForm)
      }
    }

    formBeforeLoadHandler = () => {
      let bodyInput = document.getElementById("article-body-input")
      let titleInput = document.getElementById("article-title-input")

      if (bodyInput === null || titleInput === null) {
        // we are not on a form page - this is just firing because we set it up to
window.removeEventListener('turbo:load', formBeforeLoadHandler)
        window.removeEventListener('turbo:before-visit', window.beforeVisitHandler)
        } else {
        bodyInput.addEventListener('input', updatePreview)
        titleInput.addEventListener('input', updatePreview)
        window.addEventListener('turbo:before-visit', beforeVisitHandler)
      }
    }

    window.addEventListener('turbo:load', formBeforeLoadHandler)
  </script>
</div>
